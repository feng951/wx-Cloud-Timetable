# 风表 - 技术栈文档

> 课程表管理小程序技术架构详细说明

---

## 目录

1. [项目概述](#项目概述)
2. [前端技术栈](#前端技术栈)
3. [后端技术栈](#后端技术栈)
4. [数据库](#数据库)
5. [云服务与基础设施](#云服务与基础设施)
6. [开发工具与环境](#开发工具与环境)
7. [架构图](#架构图)
8. [未来技术规划](#未来技术规划)

---

## 项目概述

**风表**是一款基于微信小程序平台开发的课程表管理应用，采用前后端分离架构，使用微信云开发（Tencent Cloud Base）作为后端服务，实现数据的云端同步与本地缓存双轨存储。

### 核心特性

- 跨平台：微信小程序原生支持 iOS/Android
- 云同步：数据实时云端备份与多设备同步
- 离线可用：本地缓存确保无网络时正常使用
- 分享功能：支持课表分享码导入导出

---

## 前端技术栈

### 1. 核心框架

| 技术 | 版本 | 用途 | 配置说明 |
|------|------|------|----------|
| **微信小程序框架** | 基础库 2.20.1 | 核心运行环境 | `project.config.json` 中配置 `"libVersion": "2.20.1"` |
| **WXML** | - | 页面结构描述 | 类 HTML 标记语言 |
| **WXSS** | - | 样式表 | 类 CSS，支持 rpx 响应式单位 |
| **JavaScript (ES6+)** | - | 业务逻辑 | 支持 async/await、箭头函数等现代语法 |

### 2. 小程序配置

```json
// app.json 核心配置
{
  "style": "v2",                    // 启用新版组件样式
  "lazyCodeLoading": "requiredComponents",  // 按需注入组件
  "window": {
    "navigationBarBackgroundColor": "#FFFFFF",
    "navigationBarTextStyle": "black"
  },
  "tabBar": {
    "color": "#999999",
    "selectedColor": "#1A1A1A"
  }
}
```

### 3. 编译配置

```json
// project.config.json 编译设置
{
  "setting": {
    "es6": true,              // 启用 ES6 转 ES5
    "enhance": true,          // 增强编译模式
    "postcss": true,          // 启用 PostCSS
    "minified": true,         // 代码压缩
    "minifyWXSS": true,       // WXSS 压缩
    "minifyWXML": true,       // WXML 压缩
    "uglifyFileName": false,  // 保持文件名可读
    "checkInvalidKey": true   // 校验不合法的 key
  }
}
```

### 4. 前端目录结构

```
miniprogram/
├── app.js                    # 小程序入口
├── app.json                  # 全局配置
├── app.wxss                  # 全局样式
├── pages/                    # 页面目录
│   ├── index/               # 首页（课表展示）
│   ├── courseInput/         # 课程录入
│   ├── timetableList/       # 课表列表
│   ├── timetableSettings/   # 课表设置
│   ├── profile/             # 个人中心
│   └── about/               # 关于页面
├── utils/                   # 工具类
│   ├── cloudApi.js          # 云API封装
│   └── courseManager.js     # 课程管理器
└── images/                  # 静态资源
```

---

## 后端技术栈

### 1. 云开发环境

| 服务 | 提供商 | 用途 | 环境ID |
|------|--------|------|--------|
| **微信云开发 (TCB)** | 腾讯云 | Serverless 后端服务 | `cloudbase-5g3l9ofwe35b022a` |

### 2. 云函数列表

| 云函数 | 功能描述 | 依赖 | 触发方式 |
|--------|----------|------|----------|
| `login` | 用户登录与注册 | wx-server-sdk | HTTP 调用 |
| `timetable` | 课表 CRUD 操作 | wx-server-sdk | HTTP 调用 |
| `shareTimetable` | 生成/导入分享码 | wx-server-sdk | HTTP 调用 |
| `userIdManager` | 用户ID管理 | wx-server-sdk | HTTP 调用 |
| `initDatabase` | 数据库初始化 | wx-server-sdk | 手动触发 |
| `generateTimetableId` | 生成唯一课表ID | wx-server-sdk | HTTP 调用 |
| `importTimetable` | 课表导入处理 | wx-server-sdk | HTTP 调用 |

### 3. 云函数依赖

```json
// package.json
{
  "dependencies": {
    "wx-server-sdk": "latest"
  }
}
```

**wx-server-sdk** 核心功能：
- 云数据库操作
- 云存储文件管理
- 云函数间调用
- 用户鉴权管理

### 4. 后端架构模式

```
┌─────────────────────────────────────┐
│           小程序前端                 │
│  ┌─────────┐ ┌─────────┐           │
│  │ 页面逻辑 │ │ 本地缓存 │           │
│  └────┬────┘ └────┬────┘           │
│       └───────────┘                 │
│              │                      │
│       ┌──────┴──────┐              │
│       │  cloudApi   │              │
│       │   封装层    │              │
│       └──────┬──────┘              │
└──────────────┼──────────────────────┘
               │
┌──────────────┼──────────────────────┐
│              ▼                      │
│      ┌──────────────┐              │
│      │  微信云开发   │              │
│      │  云函数集群   │              │
│      └──────────────┘              │
│              │                      │
│       ┌──────┴──────┐              │
│       ▼             ▼              │
│  ┌─────────┐   ┌─────────┐         │
│  │云数据库 │   │云存储   │         │
│  └─────────┘   └─────────┘         │
└─────────────────────────────────────┘
```

---

## 数据库

### 1. 数据库类型

| 数据库 | 类型 | 用途 |
|--------|------|------|
| **MongoDB (云数据库)** | 文档型 NoSQL | 主数据存储 |
| **微信小程序本地存储** | Key-Value | 离线缓存 |

### 2. 数据集合 (Collections)

| 集合名 | 描述 | 主要字段 |
|--------|------|----------|
| `users` | 用户信息 | openid, nickName, avatarUrl, createTime |
| `timetables` | 课表数据 | name, courses, isMain, userId, createTime |
| `shareCodes` | 分享码记录 | code, timetableId, expireAt, createTime |

### 3. 数据模型

#### 课表文档结构
```javascript
{
  _id: ObjectId,           // 自动生成的唯一ID
  name: String,            // 课表名称
  userId: String,          // 所属用户ID
  isMain: Boolean,         // 是否为主课表
  courses: Array[7][10],   // 7天 x 10节课的二维数组
  createTime: Date,        // 创建时间
  updateTime: Date         // 更新时间
}
```

#### 课程对象结构
```javascript
{
  name: String,            // 课程名称
  teacher: String,         // 教师
  location: String,        // 教室位置
  weeks: Array<Number>,    // 上课周数 [1,2,3...]
  startWeek: Number,       // 开始周
  endWeek: Number,         // 结束周
  startPeriod: Number,     // 开始节次
  endPeriod: Number,       // 结束节次
  color: String,           // 显示颜色
  oddEven: Number          // 0=全周, 1=单周, 2=双周
}
```

### 4. 本地存储策略

```javascript
// 本地存储键名规范
`timetables_${userId}`      // 用户课表列表
`timetable_${id}_settings`  // 课表设置
`userInfo`                  // 用户信息
`share_${code}`            // 分享码缓存
```

---

## 云服务与基础设施

### 1. 腾讯云 services

| 服务 | 用途 | 配置 |
|------|------|------|
| **云函数 (SCF)** | 业务逻辑处理 | Node.js 12/16 运行时 |
| **云数据库** | 数据持久化 | MongoDB 4.0 |
| **云存储** | 文件存储 | 预留，当前未使用 |
| **静态网站托管** | 可选部署 | 预留 |

### 2. 安全与鉴权

- **微信登录鉴权**：基于微信 openid 的用户识别
- **云开发权限**：数据库规则控制读写权限
- **数据隔离**：用户数据基于 openid 隔离

### 3. 监控与日志

- 微信开发者工具实时日志
- 云开发控制台监控
- 小程序性能监控 (可选接入)

---

## 开发工具与环境

### 1. 开发环境

| 工具 | 版本 | 用途 |
|------|------|------|
| **微信开发者工具** | Stable | 小程序开发调试 |
| **Node.js** | 14.x+ | 云函数本地调试 |
| **VS Code** | Latest | 代码编辑 (推荐) |

### 2. 推荐插件

- ESLint：代码规范检查
- Prettier：代码格式化
- minapp：小程序语法高亮

### 3. 版本控制

```bash
# Git 仓库信息
GitHub: https://github.com/feng951/wx-Cloud-Timetable.git
Gitee: https://gitee.com/beifengc/wx-cloud-timetable.git
```

---

## 架构图

### 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                  │
│  │ iOS微信  │  │安卓微信  │  │  平板   │                  │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘                  │
└───────┼─────────────┼─────────────┼──────────────────────────┘
        │             │             │
        └─────────────┴─────────────┘
                      │
┌─────────────────────┼───────────────────────────────────────┐
│                     ▼                                       │
│           ┌─────────────────┐                              │
│           │   微信小程序    │                              │
│           │   运行时环境    │                              │
│           └────────┬────────┘                              │
│                    │                                        │
│    ┌───────────────┼───────────────┐                      │
│    ▼               ▼               ▼                      │
│ ┌────────┐   ┌──────────┐   ┌──────────┐                 │
│ │ 视图层 │   │ 逻辑层   │   │ 本地存储 │                 │
│ │ WXML   │   │ JS       │   │ Storage  │                 │
│ │ WXSS   │   │          │   │          │                 │
│ └────────┘   └────┬─────┘   └──────────┘                 │
│                   │                                        │
│           ┌───────┴───────┐                              │
│           │   cloudApi    │                              │
│           │   API封装层   │                              │
│           └───────┬───────┘                              │
└───────────────────┼───────────────────────────────────────┘
                    │
┌───────────────────┼───────────────────────────────────────┐
│                   ▼                                       │
│         ┌──────────────────┐                             │
│         │   微信云开发     │                             │
│         │   Tencent Cloud │                             │
│         └────────┬─────────┘                             │
│                  │                                        │
│    ┌─────────────┼─────────────┐                        │
│    ▼             ▼             ▼                        │
│ ┌────────┐  ┌────────┐  ┌────────┐                     │
│ │云函数  │  │云数据库│  │云存储  │                     │
│ │Node.js │  │MongoDB │  │COS     │                     │
│ └────────┘  └────────┘  └────────┘                     │
└───────────────────────────────────────────────────────────┘
```

### 数据流图

```
用户操作
    │
    ▼
┌─────────────┐
│  小程序页面  │
└──────┬──────┘
       │
       ▼
┌─────────────┐     无网络     ┌─────────────┐
│  本地缓存    │ ◄────────────► │  本地显示    │
└──────┬──────┘                └─────────────┘
       │
       │ 有网络
       ▼
┌─────────────┐
│   云函数     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   云数据库   │
└─────────────┘
```

---

## 未来技术规划

### 1. 短期规划 (1-3个月)

| 功能 | 技术方案 | 优先级 |
|------|----------|--------|
| 教务系统导入 | 爬虫 + 数据解析 | 高 |
| 课程提醒 | 微信订阅消息 | 高 |
| 多设备同步优化 | 增量同步机制 | 中 |
| 课表模板 | 预设模板库 | 中 |

### 2. 中期规划 (3-6个月)

| 功能 | 技术方案 | 优先级 |
|------|----------|--------|
| 小组件 (Widget) | 微信小程序小组件 | 高 |
| 深色模式 | CSS 变量 + 主题切换 | 中 |
| 数据导出 | Excel/PDF 生成 | 中 |
| 课程评价 | 新增评价数据模型 | 低 |

### 3. 长期规划 (6-12个月)

| 功能 | 技术方案 | 优先级 |
|------|----------|--------|
| AI 课程推荐 | 腾讯云 AI 服务 | 低 |
| 跨平台支持 | Uni-app 重构 | 低 |
| 社交功能 | 实时通信 (WebSocket) | 低 |

### 4. 技术债务清理

- [ ] 云函数错误处理统一封装
- [ ] 单元测试覆盖率达到 60%
- [ ] 性能监控接入
- [ ] 代码规范文档完善

---

## 附录

### A. 环境变量配置

```javascript
// cloudApi.js
const cloud = wx.cloud;
cloud.init({
  env: 'cloudbase-5g3l9ofwe35b022a',  // 云开发环境ID
  traceUser: true                      // 跟踪用户访问
});
```

### B. 小程序 AppID

```
AppID: wx5c94c314e18b5caa
```

### C. 相关链接

- [微信小程序开发文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [微信云开发文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)
- [腾讯云云开发](https://cloud.tencent.com/product/tcb)

---

*文档版本: 1.0*  
*最后更新: 2024年*  
*维护者: BEIFENGC*
