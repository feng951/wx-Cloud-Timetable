<!--index.wxml - ä¼˜åŒ–æˆæƒæµç¨‹ç‰ˆæœ¬-->
<view class="container">
  <!-- é¡¶éƒ¨å®‰å…¨åŒºåŸŸ -->
  <view class="safe-area-top"></view>

  <!-- é¡¶éƒ¨æ—¥æœŸæ  -->
  <view class="date-header">
    <view class="date-info">
      <text class="timetable-name">{{mainTimetableName || 'æˆ‘çš„è¯¾è¡¨'}}</text>
      <view class="date-row">
        <text class="date-full">{{currentDate}}</text>
        <text class="week-info">ç¬¬ {{currentWeek}} å‘¨</text>
      </view>
    </view>
    <view class="header-actions">
      <view class="action-btn" bindtap="addCourse">+</view>
      <view class="action-btn" bindtap="manageTimetables">âš™</view>
    </view>
  </view>

  <!-- å‘¨æ•°æŒ‡ç¤ºå™¨ -->
  <view class="week-indicator">
    <view class="week-nav" bindtap="prevWeek">â€¹</view>
    <view class="week-center">
      <text class="current-week-text">ç¬¬ {{displayWeek}} å‘¨</text>
      <view wx:if="{{displayWeek !== currentWeek}}" class="back-to-current" bindtap="backToCurrentWeek">
        <text class="back-text">å›åˆ°æœ¬å‘¨</text>
      </view>
    </view>
    <view class="week-nav" bindtap="nextWeek">â€º</view>
  </view>

  <!-- æ˜ŸæœŸæ  - å¯æ»‘åŠ¨ -->
  <swiper class="week-swiper" current="{{displayWeek - 1}}" bindchange="onWeekChange" duration="300">
    <swiper-item wx:for="{{weekData}}" wx:key="week" wx:for-item="weekItem">
      <view class="week-header">
        <view class="week-label-cell">
          <text class="week-label">ç¬¬{{weekItem.week}}å‘¨</text>
        </view>
        <view wx:for="{{weekItem.days}}" wx:key="index" class="day-cell {{weekItem.week === currentWeek && currentDay === index ? 'active' : ''}} {{index === 0 ? 'is-monday' : ''}}">
          <text class="day-name">{{weekDays[index]}}</text>
          <text class="day-date">{{item.date}}</text>
          <text class="day-month" wx:if="{{item.showMonth}}">{{item.month}}æœˆ</text>
        </view>
      </view>
    </swiper-item>
  </swiper>

  <!-- è¯¾è¡¨ä¸»ä½“ -->
  <swiper class="timetable-swiper" current="{{displayWeek - 1}}" bindchange="onWeekChange" duration="300">
    <swiper-item wx:for="{{weekData}}" wx:key="week" wx:for-item="weekItem">
      <scroll-view class="timetable-scroll" scroll-y enhanced show-scrollbar="{{false}}">
        <view class="timetable-body">
          <view wx:for="{{timeSlots}}" wx:key="index" class="time-row">
            <!-- æ—¶é—´åˆ— -->
            <view class="time-cell">
              <text class="period-num">{{index + 1}}</text>
              <view class="time-range">
                <text class="start-time">{{item.start}}</text>
                <text class="end-time">{{item.end}}</text>
              </view>
            </view>
            
            <!-- è¯¾ç¨‹æ ¼å­ -->
            <view wx:for="{{weekDays}}" wx:for-index="dayIndex" wx:key="dayIndex" 
                  class="course-slot {{weekItem.week === currentWeek && currentDay === dayIndex ? 'today' : ''}}"
                  bindtap="onSlotTap" data-day="{{dayIndex}}" data-time="{{index}}" data-week="{{weekItem.week}}">
              <view wx:if="{{weekItem.courses[dayIndex][index]}}" 
                    class="course-card" 
                    style="background-color: {{weekItem.courses[dayIndex][index].color}}">
                <text class="course-name">{{weekItem.courses[dayIndex][index].name}}</text>
                <text class="course-room">{{weekItem.courses[dayIndex][index].room}}</text>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>
    </swiper-item>
  </swiper>

  <!-- å‘¨æŒ‡ç¤ºç‚¹ -->
  <view class="week-dots">
    <view wx:for="{{weekData}}" wx:key="week" 
          class="dot {{displayWeek === item.week ? 'active' : ''}}"
          bindtap="goToWeek" data-week="{{item.week}}"></view>
  </view>

  <!-- ç©ºçŠ¶æ€æç¤º -->
  <view wx:if="{{isEmpty}}" class="empty-state">
    <text class="empty-icon">ğŸ“–</text>
    <text class="empty-text">æš‚æ— è¯¾ç¨‹</text>
    <text class="empty-subtext">{{isLoggedIn ? 'ç‚¹å‡»"+"æ·»åŠ è¯¾ç¨‹æˆ–ä½¿ç”¨åˆ†äº«ç å¯¼å…¥' : 'ç™»å½•åå¯æ·»åŠ è¯¾ç¨‹æˆ–å¯¼å…¥è¯¾è¡¨'}}</text>
    <view class="empty-actions">
      <button wx:if="{{isLoggedIn}}" class="import-btn primary" bindtap="showImportDialog">å¯¼å…¥è¯¾è¡¨</button>
      <button wx:if="{{isLoggedIn}}" class="import-btn" bindtap="addCourse">æ·»åŠ è¯¾ç¨‹</button>
      <button wx:if="{{!isLoggedIn}}" class="import-btn primary" bindtap="showLoginModal">ç™»å½•/æ³¨å†Œ</button>
    </view>
  </view>

  <!-- æœªç™»å½•æç¤ºæ¡ -->
  <view wx:if="{{!isLoggedIn}}" class="login-hint-bar" bindtap="showLoginModal">
    <text class="hint-text">ğŸ”’ ç™»å½•åå¯ç¼–è¾‘è¯¾è¡¨ã€åŒæ­¥äº‘ç«¯æ•°æ®</text>
    <text class="hint-action">å»ç™»å½• â€º</text>
  </view>

  <!-- ç™»å½•å¼•å¯¼å¼¹çª— -->
  <view wx:if="{{showLoginModal}}" class="login-modal-mask" bindtap="closeLoginModal">
    <view class="login-modal" catchtap="preventClose">
      <view class="modal-close" bindtap="closeLoginModal">Ã—</view>
      
      <view class="modal-header">
        <text class="modal-title">å¾®ä¿¡ç™»å½•</text>
        <text class="modal-subtitle">ç™»å½•åå¯ç¼–è¾‘è¯¾è¡¨ã€åŒæ­¥æ•°æ®</text>
      </view>
      
      <!-- åè®®åŒæ„å‹¾é€‰ -->
      <view class="agreement-section">
        <view class="checkbox-wrapper" bindtap="toggleAgreement">
          <view class="checkbox {{hasAgreed ? 'checked' : ''}}">
            <text wx:if="{{hasAgreed}}" class="check-icon">âœ“</text>
          </view>
          <view class="agreement-text">
            <text class="text-normal">æˆ‘å·²é˜…è¯»å¹¶åŒæ„</text>
            <text class="text-link" catchtap="openUserAgreement">ã€Šç”¨æˆ·åè®®ã€‹</text>
            <text class="text-normal">å’Œ</text>
            <text class="text-link" catchtap="openPrivacyPolicy">ã€Šéšç§æ”¿ç­–ã€‹</text>
          </view>
        </view>
      </view>
      
      <view class="modal-actions">
        <button class="login-btn primary {{!hasAgreed ? 'disabled' : ''}}" bindtap="login" loading="{{isLoading}}" disabled="{{!hasAgreed || isLoading}}">
          {{isLoading ? 'ç™»å½•ä¸­...' : 'å¾®ä¿¡ä¸€é”®ç™»å½•'}}
        </button>
        <button class="login-btn secondary" bindtap="closeLoginModal">ç¨åå†è¯´</button>
      </view>
    </view>
  </view>
</view>
